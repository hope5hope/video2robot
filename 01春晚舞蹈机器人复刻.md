# 春晚舞蹈机器人复刻：完整实战记录（2026 版）

本文档记录本仓库从安装、排错到最终可运行的关键步骤，目标是让新同学尽量少踩坑。

## 一、项目目标

- 输入：文本动作描述或已有视频
- 输出：机器人动作（`robot_motion*.pkl`）与可视化（Web/viser/MuJoCo）
- 支持多人轨迹（all tracks）与多机器人 MuJoCo 录制

## 二、核心流程

```text
Prompt / Video -> PromptHMR -> SMPL-X -> GMR -> Robot Motion
```

常用命令：

```bash
python scripts/generate_video.py --model seedance --action "动作序列：角色向前走四步"
python scripts/extract_pose.py --project data/video_001
python scripts/convert_to_robot.py --project data/video_001 --all-tracks
python scripts/visualize.py --project data/video_001 --robot-viser --robot-all
```

## 三、环境安装（推荐）

### 1) GMR 环境

```bash
conda create -n gmr python=3.10 -y
conda activate gmr
cd /root/gpufree-data/video2robot
pip install -e .
```

### 2) PromptHMR 环境（4090 场景）

```bash
conda create -n phmr python=3.10 -y
conda activate phmr
cd /root/gpufree-data/video2robot/third_party/PromptHMR
bash scripts/install.sh --pt_version=2.4
```

如果自动安装失败，可用手动方案（见下文“手动配置方案”）。

## 四、Web UI 启动（稳定版）

```bash
conda activate phmr
python -m pip install -U fastapi "uvicorn[standard]" jinja2 python-multipart

pkill -f "video2robot/visualization/robot_viser.py"
cd /root/gpufree-data/video2robot
export VISER_FIXED_PORT=8789
python -m uvicorn web.app:app --host 0.0.0.0 --port 8000
```

访问：`http://localhost:8000`

说明：
- 固定 `VISER_FIXED_PORT` 是为了避免 iframe 随机端口拒绝连接
- Web 已支持中文界面、Seedance、上传视频、铁皮/彩色切换

## 五、多人轨迹与可视化

### 1) 生成多轨机器人动作

```bash
conda activate gmr
cd /root/gpufree-data/video2robot
python scripts/convert_to_robot.py --project data/video_001 --all-tracks
```

### 2) robot-viser 显示所有轨迹

```bash
python scripts/visualize.py --project data/video_001 --robot-viser --robot-all
```

## 六、MuJoCo 视频导出

### 单机器人

```bash
conda activate gmr
cd /root/gpufree-data/video2robot/third_party/GMR
python scripts/vis_robot_motion.py \
  --robot unitree_g1 \
  --robot_motion_path /root/gpufree-data/video2robot/data/video_005/robot_motion.pkl \
  --record_video \
  --video_path /root/gpufree-data/video2robot/data/video_005/mujoco_robot.mp4
```

### 多机器人（新增脚本）

```bash
python scripts/vis_robot_motion_multi.py \
  --robot unitree_g1 \
  --robot_motion_paths \
    /root/gpufree-data/video2robot/data/video_005/robot_motion_track_1.pkl \
    /root/gpufree-data/video2robot/data/video_005/robot_motion_track_2.pkl \
  --record_video \
  --max_seconds 10 \
  --camera_azimuth 0 \
  --video_path /root/gpufree-data/video2robot/data/video_005/mujoco_multi_robot_10s_front.mp4
```

说明：
- 已修复“0秒/超短视频”问题，按帧数严格控制时长
- 已修复“画面只见地面看不到机器人”问题，相机会跟随多机器人中心

## 七、落地难点与 IsaacSim 仿真展望

### 实际落地难点
1. **动作映射精度**：从视频提取的 SMPL-X 姿态到机器人关节的映射（Retargeting）存在物理限制。
2. **环境感知缺失**：目前主要是开环动作复刻，缺乏对实际地面摩擦、碰撞和障碍物的实时反馈。
3. **动力学约束**：视频中的人类动作可能超出机器人的电机扭矩或平衡极限。例如在马年春晚武术机器人表演中，高难度的腾空与受力对伺服响应要求极高。

### IsaacSim 仿真优势
未来我们将引入 **IsaacSim** 进行强化学习训练：
- **优势**：极高的物理仿真精度，支持复杂的碰撞检测、摩擦力模型和传感器仿真。
- **价值**：本项目主要完成“动作映射”，IsaacSim 则负责“动作稳健性训练”。

## 八、常见问题速查与 Debug 记录

### Q1: `conda` 找不到（Web任务秒退）
已在主仓库任务运行器中修复，支持自动探测 `CONDA_EXE`。

### Q2: robot-viser 偶发 `localhost 拒绝连接`
优先使用固定端口：`export VISER_FIXED_PORT=8789`。

### Q3: MuJoCo 录制报 `imageio` backend 缺失
执行：`pip install -U "imageio[ffmpeg]"`。

### Q4: 编译错误（lietorch/droid_backends）
针对 PyTorch 2.4+，需将 `.type()` 修改为 `.scalar_type()`。

## 九、仓库交付建议（submodule 不并入）

建议保留 submodule，用 patch 交付改动。

### 记录基线 commit
- 主仓库：`030f3410dac3cb15a2570376dca6a0f46c2d158c`
- PromptHMR：`4f8915c5b9603344c56e95fadb9a01a23ba2272d`
- GMR：`069b4fd48f440e813b2b4d69255c70f53e5f83fb`

## 十、你的 fork（当前）
你已 fork 到：[hope5hope/video2robot](https://github.com/hope5hope/video2robot)

---

## 附录：手动配置方案参考

```bash
# Clone repo (with submodules)
git clone --recursive https://github.com/AIM-Intelligence/video2robot.git
cd video2robot

# Or initialize submodules after cloning
git submodule update --init --recursive

conda create -n phmr python=3.10 -y
conda activate phmr
cd /root/gpufree-data/video2robot/third_party/PromptHMR
pip install -r requirements.txt

mkdir -p python_libs
git clone https://github.com/Arthur151/chumpy python_libs/chumpy
python -m pip install -e python_libs/chumpy --no-build-isolation

# 在 bashrc 中加入
export PYTHONPATH=$PYTHONPATH:/root/gpufree-data/video2robot/third_party/PromptHMR

conda install -c conda-forge eigen -y

# 编译 lietorch
mkdir -p python_libs
cd python_libs
git clone https://github.com/princeton-vl/lietorch.git
cd lietorch
python setup.py install
cd ../..

# 安装 detectron2
git clone https://github.com/facebookresearch/detectron2.git
cd /root/gpufree-data/detectron2
pip install -e . --no-build-isolation

# 安装 SAM2
git clone https://github.com/facebookresearch/segment-anything-2.git
cd segment-anything-2
pip install -e . --no-build-isolation

# 适配代码
sed -i 's/load_video_frames, load_video_frames_from_np/load_video_frames/g' /root/gpufree-data/video2robot/third_party/PromptHMR/pipeline/detector/sam2_video_predictor.py

合并patch
```

下载相关模型权重：
```bash
cd /root/gpufree-data/video2robot/third_party/PromptHMR
bash scripts/fetch_smplx.sh
bash scripts/fetch_data.sh
```

### 合并 Patch 命令（快速同步改动）
如果你是在原始仓库基础上进行同步，可以使用以下命令合并补丁：

```bash
cd /root/gpufree-data/video2robot

# 1. 确保子模块已初始化
git submodule update --init --recursive

# 2. 应用主仓库补丁
git apply patches/main.patch

# 3. 应用 PromptHMR 补丁
git -C third_party/PromptHMR apply ../../patches/prompthmr.patch

# 4. 应用 GMR 补丁
git -C third_party/GMR apply ../../patches/gmr.patch
```
